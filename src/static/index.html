<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utility Bill Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
            border: none;
        }
        
        .nav-tabs .nav-link:hover {
            border: none;
            background: rgba(13, 110, 253, 0.1);
        }
        
        .table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem;
            font-weight: 600;
        }
        
        .table tbody td {
            padding: 1rem;
            border-color: #f8f9fa;
            vertical-align: middle;
        }
        
        .overage-row {
            background-color: rgba(220, 53, 69, 0.05);
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, var(--success-color), #146c43);
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(25, 135, 84, 0.3);
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .allowance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .allowance-item:last-child {
            border-bottom: none;
        }
        
        .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-calculator me-3"></i>Utility Bill Calculator</h1>
                <p class="mb-0">Calculate monthly utility overages and manage property allowances</p>
            </div>
            
            <div class="row p-4">
                <!-- Sidebar -->
                <div class="col-md-3">
                    <div class="sidebar">
                        <h5 class="mb-3"><i class="fas fa-cogs me-2"></i>Room-Based Allowances:</h5>
                        <div class="allowance-item">
                            <span>1 room:</span>
                            <span class="badge bg-primary">â‚¬50</span>
                        </div>
                        <div class="allowance-item">
                            <span>2 room:</span>
                            <span class="badge bg-primary">â‚¬70</span>
                        </div>
                        <div class="allowance-item">
                            <span>3 room:</span>
                            <span class="badge bg-primary">â‚¬100</span>
                        </div>
                        <div class="allowance-item">
                            <span>4 room:</span>
                            <span class="badge bg-primary">â‚¬130</span>
                        </div>
                        <div class="allowance-item">
                            <span>Padilla 1Âº 3Âª:</span>
                            <span class="badge bg-warning">â‚¬150</span>
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="autoSave" checked>
                            <label class="form-check-label" for="autoSave">
                                Auto-save to database
                            </label>
                        </div>
                        
                        <button class="btn btn-success btn-calculate w-100 mt-3" onclick="calculateReport()">
                            <i class="fas fa-calculator me-2"></i>Calculate Monthly Report
                        </button>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="col-md-9">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-icon text-warning">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="metric-value" id="totalElecCost">â‚¬0.00</div>
                                <div class="metric-label">Total Electricity</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-icon text-info">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="metric-value" id="totalWaterCost">â‚¬0.00</div>
                                <div class="metric-label">Total Water</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-icon text-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="metric-value" id="totalExtra">â‚¬0.00</div>
                                <div class="metric-label">Total Extra</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-icon text-success">
                                    <i class="fas fa-home"></i>
                                </div>
                                <div class="metric-value" id="totalProperties">0</div>
                                <div class="metric-label">Properties</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-table me-2"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="overages-tab" data-bs-toggle="tab" data-bs-target="#overages" type="button" role="tab">
                                <i class="fas fa-exclamation-triangle me-2"></i>Overages
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">
                                <i class="fas fa-chart-bar me-2"></i>Charts
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab">
                                <i class="fas fa-envelope me-2"></i>Email Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="mainTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="loading" id="loadingOverview">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Calculating report...</p>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Allowance</th>
                                            <th>Electricity Cost</th>
                                            <th>Water Cost</th>
                                            <th>Total Cost</th>
                                            <th>Total Extra</th>
                                        </tr>
                                    </thead>
                                    <tbody id="overviewTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">Click "Calculate Monthly Report" to load data</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Overages Tab -->
                        <div class="tab-pane fade" id="overages" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Allowance</th>
                                            <th>Total Cost</th>
                                            <th>Total Extra</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="overagesTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No overages data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Charts Tab -->
                        <div class="tab-pane fade" id="charts" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="metric-card">
                                        <h5 class="mb-3">Cost Distribution</h5>
                                        <canvas id="costChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="metric-card">
                                        <h5 class="mb-3">Overages by Property</h5>
                                        <canvas id="overagesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email Management Tab -->
                        <div class="tab-pane fade" id="email" role="tabpanel">
                            <div class="row">
                                <!-- Email Actions -->
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <h5 class="mb-3"><i class="fas fa-envelope me-2"></i>Email Actions</h5>
                                        
                                        <button class="btn btn-warning w-100 mb-3" onclick="generateBulkEmails()">
                                            <i class="fas fa-bolt me-2"></i>Generate All Emails
                                        </button>
                                        
                                        <button class="btn btn-info w-100 mb-3" onclick="loadPendingApprovals()">
                                            <i class="fas fa-clock me-2"></i>Pending Approvals
                                            <span class="badge bg-danger ms-2" id="pendingCount">0</span>
                                        </button>
                                        
                                        <button class="btn btn-success w-100 mb-3" onclick="loadSentEmails()">
                                            <i class="fas fa-check me-2"></i>Sent Emails
                                        </button>
                                        
                                        <button class="btn btn-secondary w-100 mb-3" onclick="loadEmailStatistics()">
                                            <i class="fas fa-chart-bar me-2"></i>Statistics
                                        </button>
                                        
                                        <hr>
                                        
                                        <button class="btn btn-info w-100 mb-3" onclick="testRealInvoiceDownload()">
                                            <i class="fas fa-download me-2"></i>Test Real Invoice Download
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Email Content -->
                                <div class="col-md-8">
                                    <div class="metric-card">
                                        <h5 class="mb-3"><i class="fas fa-list me-2"></i>Email Management</h5>
                                        
                                        <!-- Email List -->
                                        <div id="emailList">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-envelope fa-3x mb-3"></i>
                                                <p>Click "Generate All Emails" to start the email workflow</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Email Preview Modal -->
                                        <div class="modal fade" id="emailPreviewModal" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Email Preview</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div id="emailPreviewContent">
                                                            <!-- Email preview content will be loaded here -->
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="button" class="btn btn-danger" onclick="rejectEmail()">Reject</button>
                                                        <button type="button" class="btn btn-success" onclick="approveEmail()">Approve & Send</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Tab -->
                        <div class="tab-pane fade" id="export" role="tabpanel">
                            <div class="metric-card">
                                <h5 class="mb-3"><i class="fas fa-download me-2"></i>Export Options</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <button class="btn btn-primary w-100 mb-2" onclick="exportToCSV()">
                                            <i class="fas fa-file-csv me-2"></i>Export to CSV
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-success w-100 mb-2" onclick="exportToExcel()">
                                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = null;
        
        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            updatePendingCount();
        });
        
        function saveDataToStorage(data) {
            try {
                localStorage.setItem('polaroo_calculation_data', JSON.stringify(data));
                localStorage.setItem('polaroo_calculation_timestamp', new Date().toISOString());
                console.log('ðŸ“¦ Data saved to localStorage');
            } catch (error) {
                console.error('Failed to save data to localStorage:', error);
            }
        }
        
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('polaroo_calculation_data');
                const timestamp = localStorage.getItem('polaroo_calculation_timestamp');
                
                if (savedData && timestamp) {
                    const data = JSON.parse(savedData);
                    const saveTime = new Date(timestamp);
                    const now = new Date();
                    const hoursSinceCalculation = (now - saveTime) / (1000 * 60 * 60);
                    
                    // Only load if data is less than 24 hours old
                    if (hoursSinceCalculation < 24) {
                        currentData = data;
                        updateUI(data);
                        console.log(`ðŸ“¦ Loaded saved data from ${saveTime.toLocaleString()}`);
                        
                        // Show data age indicator
                        showDataAge(saveTime);
                    } else {
                        // Clear old data
                        localStorage.removeItem('polaroo_calculation_data');
                        localStorage.removeItem('polaroo_calculation_timestamp');
                        console.log('ðŸ§¹ Cleared old calculation data');
                    }
                }
            } catch (error) {
                console.error('Failed to load saved data:', error);
            }
        }
        
        function showDataAge(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            
            let ageText = '';
            if (hours > 0) {
                ageText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                ageText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            }
            
            // Add age indicator to the header
            const header = document.querySelector('.header h1');
            if (header && !header.querySelector('.data-age')) {
                const ageIndicator = document.createElement('small');
                ageIndicator.className = 'data-age text-light opacity-75 ms-3';
                ageIndicator.innerHTML = `<i class="fas fa-clock me-1"></i>Last calculated ${ageText}`;
                header.appendChild(ageIndicator);
            }
        }
        
        async function calculateReport() {
            const loadingElement = document.getElementById('loadingOverview');
            const calculateBtn = document.querySelector('.btn-calculate');
            
            // Show loading state
            loadingElement.style.display = 'block';
            calculateBtn.disabled = true;
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating...';
            
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: new Date().getMonth() + 1,
                        year: new Date().getFullYear()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    updateUI(result.data);
                    saveDataToStorage(result.data); // Save to localStorage
                    showSuccessMessage('Report calculated successfully!');
                } else {
                    throw new Error(result.error || 'Calculation failed');
                }
                
            } catch (error) {
                console.error('Error calculating report:', error);
                showErrorMessage('Failed to calculate report: ' + error.message);
            } finally {
                // Hide loading state
                loadingElement.style.display = 'none';
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<i class="fas fa-calculator me-2"></i>Calculate Monthly Report';
            }
        }
        
        function updateUI(data) {
            // Update summary cards
            document.getElementById('totalElecCost').textContent = `â‚¬${data.summary.total_electricity_cost.toFixed(2)}`;
            document.getElementById('totalWaterCost').textContent = `â‚¬${data.summary.total_water_cost.toFixed(2)}`;
            document.getElementById('totalExtra').textContent = `â‚¬${data.summary.total_extra.toFixed(2)}`;
            document.getElementById('totalProperties').textContent = data.summary.total_properties;
            
            // Populate overview table
            const tbody = document.getElementById('overviewTableBody');
            tbody.innerHTML = '';
            
            data.properties.forEach(property => {
                const totalCost = property.elec_cost + property.water_cost;
                const hasOverages = property.total_extra > 0;
                
                const row = document.createElement('tr');
                if (hasOverages) row.className = 'overage-row';
                
                row.innerHTML = `
                    <td><strong>${property.name}</strong></td>
                    <td><span class="badge bg-primary">â‚¬${property.allowance.toFixed(0)}</span></td>
                    <td>â‚¬${property.elec_cost.toFixed(2)}</td>
                    <td>â‚¬${property.water_cost.toFixed(2)}</td>
                    <td><strong>â‚¬${totalCost.toFixed(2)}</strong></td>
                    <td class="${property.total_extra > 0 ? 'text-danger' : ''}"><strong>â‚¬${property.total_extra.toFixed(2)}</strong></td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update overages table
            updateOveragesTable(data);
            
            // Update charts
            updateCharts(data);
        }
        
        function updateOveragesTable(data) {
            const overages = data.properties.filter(p => p.total_extra > 0);
            const tbody = document.getElementById('overagesTableBody');
            tbody.innerHTML = '';
            
            if (overages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-success">No overages found!</td></tr>';
                return;
            }
            
            overages.forEach(property => {
                const totalCost = property.elec_cost + property.water_cost;
                const row = document.createElement('tr');
                row.className = 'overage-row';
                
                row.innerHTML = `
                    <td>
                        <a href="#" class="property-link text-decoration-none" onclick="openEmailDraftTab('${property.name}'); return false;">
                            <strong>${property.name}</strong>
                            <i class="fas fa-external-link-alt ms-1 text-muted"></i>
                        </a>
                    </td>
                    <td><span class="badge bg-primary">â‚¬${property.allowance.toFixed(0)}</span></td>
                    <td><strong>â‚¬${totalCost.toFixed(2)}</strong></td>
                    <td class="text-danger"><strong>â‚¬${property.total_extra.toFixed(2)}</strong></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-warning" onclick="generateEmailForProperty('${property.name}')">
                                <i class="fas fa-envelope me-1"></i>Old Email
                            </button>
                            <button class="btn btn-sm btn-success" onclick="createGmailDraft('${property.name}')">
                                <i class="fas fa-draft2digital me-1"></i>Gmail Draft
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateCharts(data) {
            // Cost Distribution Chart
            const costCtx = document.getElementById('costChart').getContext('2d');
            new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Electricity', 'Water'],
                    datasets: [{
                        data: [data.summary.total_electricity_cost, data.summary.total_water_cost],
                        backgroundColor: ['#ffc107', '#17a2b8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Overages Chart
            const overagesCtx = document.getElementById('overagesChart').getContext('2d');
            const overages = data.properties.filter(p => p.total_extra > 0);
            
            new Chart(overagesCtx, {
                type: 'bar',
                data: {
                    labels: overages.map(p => p.name.substring(0, 15) + '...'),
                    datasets: [{
                        label: 'Total Extra (â‚¬)',
                        data: overages.map(p => p.total_extra),
                        backgroundColor: '#dc3545',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function showSuccessMessage(message) {
            // You can implement a toast notification here
            console.log('Success:', message);
        }
        
        function showErrorMessage(message) {
            // You can implement a toast notification here
            console.error('Error:', message);
            alert(message); // Temporary alert for debugging
        }
        
        function exportToCSV() {
            if (!currentData) {
                alert('No data to export. Please calculate a report first.');
                return;
            }
            
            const csvContent = generateCSV(currentData);
            downloadFile(csvContent, 'utility_report.csv', 'text/csv');
        }
        
        function exportToExcel() {
            if (!currentData) {
                alert('No data to export. Please calculate a report first.');
                return;
            }
            
            // For Excel export, you might want to use a library like SheetJS
            alert('Excel export feature coming soon!');
        }
        
        function generateCSV(data) {
            const headers = ['Property', 'Allowance', 'Electricity Cost', 'Water Cost', 'Total Cost', 'Total Extra'];
            const rows = data.properties.map(property => [
                property.name,
                property.allowance,
                property.elec_cost,
                property.water_cost,
                property.elec_cost + property.water_cost,
                property.total_extra
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            return csvContent;
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // ============================================================================
        // EMAIL MANAGEMENT FUNCTIONS
        // ============================================================================
        
        let currentEmailId = null;
        
        async function generateBulkEmails() {
            try {
                showLoadingMessage('Generating emails for all properties with overages...');
                
                const response = await fetch('/api/email/generate-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage(`Generated ${result.generated_emails} emails successfully!`);
                    displayEmailResults(result.emails);
                    updatePendingCount();
                } else {
                    throw new Error(result.message || 'Failed to generate emails');
                }
                
            } catch (error) {
                console.error('Error generating bulk emails:', error);
                showErrorMessage('Failed to generate emails: ' + error.message);
            } finally {
                hideLoadingMessage();
            }
        }
        
        async function generateEmailForProperty(propertyName) {
            try {
                showLoadingMessage(`Generating email for ${propertyName}...`);
                
                const response = await fetch('/api/email/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_name: propertyName,
                        require_approval: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage(`Email generated for ${propertyName}!`);
                    updatePendingCount();
                } else {
                    throw new Error(result.message || 'Failed to generate email');
                }
                
            } catch (error) {
                console.error('Error generating email:', error);
                showErrorMessage('Failed to generate email: ' + error.message);
            } finally {
                hideLoadingMessage();
            }
        }
        
        async function loadPendingApprovals() {
            try {
                const response = await fetch('/api/email/pending-approvals');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayPendingEmails(result.emails);
                } else {
                    throw new Error('Failed to load pending approvals');
                }
                
            } catch (error) {
                console.error('Error loading pending approvals:', error);
                showErrorMessage('Failed to load pending approvals: ' + error.message);
            }
        }
        
        async function loadSentEmails() {
            try {
                const response = await fetch('/api/email/sent');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displaySentEmails(result.emails);
                } else {
                    throw new Error('Failed to load sent emails');
                }
                
            } catch (error) {
                console.error('Error loading sent emails:', error);
                showErrorMessage('Failed to load sent emails: ' + error.message);
            }
        }
        
        async function loadEmailStatistics() {
            try {
                const response = await fetch('/api/email/statistics');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayEmailStatistics(result.email_statistics, result.invoice_statistics);
                } else {
                    throw new Error('Failed to load email statistics');
                }
                
            } catch (error) {
                console.error('Error loading email statistics:', error);
                showErrorMessage('Failed to load email statistics: ' + error.message);
            }
        }
        
        function displayEmailResults(emails) {
            const emailList = document.getElementById('emailList');
            
            if (emails.length === 0) {
                emailList.innerHTML = `
                    <div class="text-center text-success">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No properties with overages found!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Email Address</th>
                        <th>Total Extra</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            emails.forEach(email => {
                const statusBadge = getStatusBadge(email.status);
                html += `
                    <tr>
                        <td><strong>${email.property_name}</strong></td>
                        <td>${email.email_address}</td>
                        <td class="text-danger"><strong>â‚¬${email.total_extra.toFixed(2)}</strong></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="previewEmail('${email.email_id}')">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            emailList.innerHTML = html;
        }
        
        function displayPendingEmails(emails) {
            const emailList = document.getElementById('emailList');
            
            if (emails.length === 0) {
                emailList.innerHTML = `
                    <div class="text-center text-success">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No emails pending approval!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Email Address</th>
                        <th>Total Extra</th>
                        <th>Queued At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            emails.forEach(approval => {
                const preview = approval.preview;
                const queuedAt = new Date(approval.queued_at).toLocaleString();
                
                html += `
                    <tr>
                        <td><strong>${preview.property_name}</strong></td>
                        <td>${preview.email_address}</td>
                        <td class="text-danger"><strong>â‚¬${preview.total_extra.toFixed(2)}</strong></td>
                        <td>${queuedAt}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="previewEmail('${approval.email_id}')">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            emailList.innerHTML = html;
        }
        
        function displaySentEmails(emails) {
            const emailList = document.getElementById('emailList');
            
            if (emails.length === 0) {
                emailList.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-envelope fa-3x mb-3"></i>
                        <p>No emails sent yet!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Email Address</th>
                        <th>Total Extra</th>
                        <th>Sent At</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            emails.forEach(email => {
                const sentAt = new Date(email.sent_at).toLocaleString();
                const statusBadge = getStatusBadge(email.status);
                
                html += `
                    <tr>
                        <td><strong>${email.property_name}</strong></td>
                        <td>${email.email_address}</td>
                        <td class="text-danger"><strong>â‚¬${email.total_extra.toFixed(2)}</strong></td>
                        <td>${sentAt}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            emailList.innerHTML = html;
        }
        
        function displayEmailStatistics(emailStats, invoiceStats) {
            const emailList = document.getElementById('emailList');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6><i class="fas fa-envelope me-2"></i>Email Statistics</h6>
                            <ul class="list-unstyled">
                                <li><strong>Pending Approvals:</strong> ${emailStats.pending_approvals}</li>
                                <li><strong>Sent Emails:</strong> ${emailStats.sent_emails}</li>
                                <li><strong>Total Emails:</strong> ${emailStats.total_emails}</li>
                                <li><strong>Mode:</strong> ${emailStats.offline_mode ? 'Offline (Testing)' : 'Production'}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6><i class="fas fa-file-pdf me-2"></i>Invoice Statistics</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total Properties:</strong> ${invoiceStats.total_properties}</li>
                                <li><strong>Total Invoices:</strong> ${invoiceStats.total_invoices}</li>
                                <li><strong>Electricity Invoices:</strong> ${invoiceStats.electricity_invoices}</li>
                                <li><strong>Water Invoices:</strong> ${invoiceStats.water_invoices}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            emailList.innerHTML = html;
        }
        
        async function previewEmail(emailId) {
            try {
                currentEmailId = emailId;
                
                // Get pending approvals to find the email data
                const response = await fetch('/api/email/pending-approvals');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Failed to load email data');
                }
                
                const emailData = result.emails.find(email => email.email_id === emailId);
                
                if (!emailData) {
                    throw new Error('Email not found');
                }
                
                const preview = emailData.preview;
                const emailContent = emailData.email_data;
                
                const previewContent = document.getElementById('emailPreviewContent');
                previewContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>Email Details</h6>
                            <ul class="list-unstyled">
                                <li><strong>Property:</strong> ${preview.property_name}</li>
                                <li><strong>To:</strong> ${preview.email_address}</li>
                                <li><strong>Subject:</strong> ${preview.subject}</li>
                                <li><strong>Total Extra:</strong> â‚¬${preview.total_extra.toFixed(2)}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-file-pdf me-2"></i>Attachments</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-bolt text-warning"></i> Electricity Invoice</li>
                                <li><i class="fas fa-tint text-info"></i> Water Invoice</li>
                            </ul>
                        </div>
                    </div>
                    <hr>
                    <h6><i class="fas fa-envelope me-2"></i>Email Content</h6>
                    <div class="border p-3 bg-light" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">
                        ${emailContent.body}
                    </div>
                `;
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('emailPreviewModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error previewing email:', error);
                showErrorMessage('Failed to preview email: ' + error.message);
            }
        }
        
        async function approveEmail() {
            if (!currentEmailId) {
                showErrorMessage('No email selected for approval');
                return;
            }
            
            try {
                const response = await fetch('/api/email/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email_id: currentEmailId,
                        action: 'approve'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage('Email approved and sent successfully!');
                    updatePendingCount();
                    loadPendingApprovals(); // Refresh the list
                } else {
                    throw new Error(result.message || 'Failed to approve email');
                }
                
            } catch (error) {
                console.error('Error approving email:', error);
                showErrorMessage('Failed to approve email: ' + error.message);
            } finally {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('emailPreviewModal'));
                if (modal) {
                    modal.hide();
                }
                currentEmailId = null;
            }
        }
        
        async function rejectEmail() {
            if (!currentEmailId) {
                showErrorMessage('No email selected for rejection');
                return;
            }
            
            const reason = prompt('Please provide a reason for rejecting this email:');
            if (!reason) {
                return;
            }
            
            try {
                const response = await fetch('/api/email/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email_id: currentEmailId,
                        action: 'reject',
                        reason: reason
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage('Email rejected successfully!');
                    updatePendingCount();
                    loadPendingApprovals(); // Refresh the list
                } else {
                    throw new Error(result.message || 'Failed to reject email');
                }
                
            } catch (error) {
                console.error('Error rejecting email:', error);
                showErrorMessage('Failed to reject email: ' + error.message);
            } finally {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('emailPreviewModal'));
                if (modal) {
                    modal.hide();
                }
                currentEmailId = null;
            }
        }
        
        async function updatePendingCount() {
            try {
                const response = await fetch('/api/email/pending-approvals');
                const result = await response.json();
                
                if (result.success) {
                    const pendingCount = document.getElementById('pendingCount');
                    pendingCount.textContent = result.pending_count;
                    pendingCount.style.display = result.pending_count > 0 ? 'inline' : 'none';
                }
            } catch (error) {
                console.error('Error updating pending count:', error);
            }
        }
        
        function getStatusBadge(status) {
            const badges = {
                'pending_approval': '<span class="badge bg-warning">Pending Approval</span>',
                'approved': '<span class="badge bg-info">Approved</span>',
                'sent': '<span class="badge bg-success">Sent</span>',
                'rejected': '<span class="badge bg-danger">Rejected</span>',
                'failed': '<span class="badge bg-danger">Failed</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }
        
        function showLoadingMessage(message) {
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }
        
        function hideLoadingMessage() {
            // Loading message will be replaced by actual content
        }
        
        // Remove this old event listener as we now have a combined one above
        
        // ============================================================================
        // REAL INVOICE DOWNLOAD TESTING
        // ============================================================================
        
        async function testRealInvoiceDownload() {
            try {
                // Get property name from user
                const propertyName = prompt('Enter property name to test invoice download:');
                if (!propertyName) {
                    return;
                }
                
                showLoadingMessage(`Testing real invoice download for ${propertyName}...`);
                
                const response = await fetch('/api/invoices/download-real', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_name: propertyName
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage(`Successfully downloaded ${result.total_files} invoices for ${propertyName}!`);
                    displayInvoiceDownloadResults(result);
                } else {
                    throw new Error(result.message || 'Failed to download invoices');
                }
                
            } catch (error) {
                console.error('Error testing real invoice download:', error);
                showErrorMessage('Failed to test real invoice download: ' + error.message);
            } finally {
                hideLoadingMessage();
            }
        }
        
        function displayInvoiceDownloadResults(result) {
            const emailList = document.getElementById('emailList');
            
            let html = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Invoice Download Results</h6>
                    <p><strong>Property:</strong> ${result.property_name}</p>
                    <p><strong>Total Files:</strong> ${result.total_files}</p>
                    <p><strong>Message:</strong> ${result.message}</p>
                </div>
            `;
            
            if (result.downloaded_files && result.downloaded_files.length > 0) {
                html += `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Size (bytes)</th>
                                    <th>Created At</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                result.downloaded_files.forEach(file => {
                    html += `
                        <tr>
                            <td><strong>${file.filename}</strong></td>
                            <td>${file.size_bytes.toLocaleString()}</td>
                            <td>${new Date(file.created_at).toLocaleString()}</td>
                            <td><code>${file.path}</code></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            emailList.innerHTML = html;
        }
        
        // ============================================================================
        // GMAIL DRAFT GENERATOR INTEGRATION
        // ============================================================================
        
        async function openEmailDraftTab(propertyName) {
            /**
             * Opens a new tab with Gmail draft creation interface
             */
            console.log(`ðŸ”— Opening Gmail draft tab for property: ${propertyName}`);
            
            // Create URL with property information
            const draftUrl = `/gmail-draft?property=${encodeURIComponent(propertyName)}`;
            
            // Open in new tab
            const newTab = window.open(draftUrl, '_blank');
            
            if (newTab) {
                newTab.focus();
                showSuccessMessage(`Opening Gmail draft for ${propertyName} in new tab`);
            } else {
                showErrorMessage('Popup blocked! Please allow popups for this site.');
            }
        }
        
        async function createGmailDraft(propertyName) {
            /**
             * Create Gmail draft using the integrated draft generator
             */
            console.log(`ðŸ“§ Creating Gmail draft for property: ${propertyName}`);
            
            try {
                showLoadingMessage(`Creating Gmail draft for ${propertyName}...`);
                
                const response = await fetch('/api/gmail/create-draft', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_name: propertyName,
                        include_cc_recipients: true,
                        attach_pdfs: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage(`Gmail draft created successfully for ${propertyName}!`);
                    
                    // Show draft details
                    displayGmailDraftResult(result);
                    
                    // Ask user if they want to open Gmail
                    if (confirm('Gmail draft created! Would you like to open Gmail to review it?')) {
                        window.open('https://mail.google.com/mail/u/0/#drafts', '_blank');
                    }
                } else {
                    throw new Error(result.message || 'Failed to create Gmail draft');
                }
                
            } catch (error) {
                console.error('Error creating Gmail draft:', error);
                showErrorMessage('Failed to create Gmail draft: ' + error.message);
            } finally {
                hideLoadingMessage();
            }
        }
        
        function displayGmailDraftResult(result) {
            /**
             * Display Gmail draft creation results
             */
            const emailList = document.getElementById('emailList');
            
            let html = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Gmail Draft Created Successfully!</h6>
                    <p><strong>Property:</strong> ${result.property_name}</p>
                    <p><strong>Recipients:</strong> ${result.recipient_count} (including CC)</p>
                    <p><strong>Attachments:</strong> ${result.attachment_count} PDFs</p>
                    <p><strong>Draft ID:</strong> ${result.draft_id}</p>
                </div>
            `;
            
            if (result.recipients && result.recipients.length > 0) {
                html += `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    <th>Type</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                result.recipients.forEach(recipient => {
                    html += `
                        <tr>
                            <td>${recipient.email}</td>
                            <td><span class="badge ${recipient.type === 'to' ? 'bg-primary' : 'bg-secondary'}">${recipient.type.toUpperCase()}</span></td>
                            <td>Book1.xlsx</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            if (result.attachments && result.attachments.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6><i class="fas fa-paperclip me-2"></i>Attachments</h6>
                        <ul class="list-unstyled">
                `;
                
                result.attachments.forEach(attachment => {
                    html += `<li><i class="fas fa-file-pdf text-danger me-2"></i>${attachment.filename}</li>`;
                });
                
                html += '</ul></div>';
            }
            
            html += `
                <div class="mt-3">
                    <a href="https://mail.google.com/mail/u/0/#drafts" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-2"></i>Open Gmail Drafts
                    </a>
                </div>
            `;
            
            emailList.innerHTML = html;
        }
        
        async function loadBookOneEmails(propertyName) {
            /**
             * Load email addresses for a property from Book1.xlsx
             */
            try {
                const response = await fetch('/api/book1/emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_name: propertyName
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return result.emails || [];
                } else {
                    throw new Error(result.message || 'Failed to load emails');
                }
                
            } catch (error) {
                console.error('Error loading Book1 emails:', error);
                return [];
            }
        }
    </script>
</body>
</html>
